<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Mental Health Support Companion</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      margin: 0; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
      color: #fff; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      overflow: hidden;
      height: 100vh;
    }
    
    #avatar { 
      position: absolute; 
      inset: 0; 
      z-index: 1;
    }

    .disclaimer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 152, 0, 0.9);
      color: #000;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 15;
      text-align: center;
      max-width: 90%;
    }
    
    #bot-response {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      padding: 20px 25px;
      border-radius: 20px;
      max-width: 90%;
      text-align: left;
      font-size: 16px;
      line-height: 1.5;
      border: 2px solid rgba(76, 175, 80, 0.3);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 10;
      transition: all 0.3s ease;
    }
    
    #inputbar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 85%;
      max-width: 800px;
      display: flex;
      gap: 12px;
      z-index: 10;
    }
    
    #inputbar input {
      flex: 1;
      padding: 18px 25px;
      border-radius: 25px;
      border: none;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      outline: none;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    #inputbar input:focus {
      background: rgba(255, 255, 255, 1);
      border: 2px solid #4CAF50;
      transform: scale(1.02);
    }
    
    #micBtn {
      padding: 18px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 20px;
      min-width: 60px;
      background: linear-gradient(45deg, #4CAF50, #66BB6A);
      color: #fff;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }
    
    #micBtn:hover { 
      background: linear-gradient(45deg, #66BB6A, #81C784);
      transform: scale(1.05);
    }
    
    #micBtn.listening {
      background: linear-gradient(45deg, #FF5722, #FF7043);
      animation: breathe 2s infinite;
      box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6);
    }
    
    #sendBtn {
      padding: 18px 30px;
      border-radius: 25px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      background: linear-gradient(45deg, #2196F3, #42A5F5);
      color: #fff;
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    }
    
    #sendBtn:hover { 
      background: linear-gradient(45deg, #42A5F5, #64B5F6);
      transform: scale(1.05);
    }
    
    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .voice-controls {
      position: absolute;
      top: 60px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      padding: 12px;
      border-radius: 15px;
      font-size: 12px;
      border: 2px solid rgba(76, 175, 80, 0.3);
      z-index: 10;
      min-width: 160px;
      max-width: 180px;
    }
    
    .voice-controls h3 {
      margin-bottom: 8px;
      color: #4CAF50;
      font-size: 14px;
      text-align: center;
    }
    
    .voice-controls label {
      display: block;
      margin-bottom: 6px;
      color: #E8F5E8;
      font-weight: 500;
      font-size: 11px;
    }
    
    .voice-controls select, .voice-controls input {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 6px 8px;
      border-radius: 8px;
      width: 100%;
      margin-bottom: 8px;
      font-size: 11px;
    }
    
    .voice-controls input[type="range"] {
      accent-color: #4CAF50;
      height: 4px;
    }
    
    .voice-controls button {
      background: linear-gradient(45deg, #4CAF50, #66BB6A);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      margin-bottom: 4px;
      transition: all 0.3s ease;
      font-size: 11px;
    }
    
    .voice-controls button:hover {
      background: linear-gradient(45deg, #66BB6A, #81C784);
      transform: translateY(-1px);
    }
    
    .status-indicator {
      position: absolute;
      top: 60px;
      left: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      padding: 15px 20px;
      border-radius: 15px;
      font-size: 13px;
      border: 2px solid rgba(76, 175, 80, 0.3);
      z-index: 10;
    }
    
    .mic-status {
      position: absolute;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(45deg, #4CAF50, #66BB6A);
      color: white;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 14px;
      display: none;
      z-index: 15;
      animation: fadeInOut 0.3s ease;
      text-align: center;
      max-width: 400px;
      font-weight: 500;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      100% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    .online { color: #4CAF50; }
    .offline { color: #FF5722; }
    .listening { color: #FF9800; }
    
    .emergency-notice {
      position: absolute;
      bottom: 100px;
      right: 20px;
      background: rgba(244, 67, 54, 0.9);
      color: #fff;
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 12px;
      z-index: 15;
      max-width: 200px;
      text-align: center;
      font-weight: bold;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      #inputbar { width: 95%; }
      .voice-controls { 
        top: 70px; 
        right: 5px; 
        padding: 8px;
        min-width: 140px;
        max-width: 150px;
        font-size: 10px;
      }
      .voice-controls h3 {
        font-size: 12px;
        margin-bottom: 6px;
      }
      .voice-controls button {
        padding: 5px 8px;
        font-size: 10px;
      }
      #bot-response { 
        bottom: 150px; 
        max-width: 95%; 
        font-size: 15px;
        padding: 15px 20px;
      }
      .disclaimer {
        font-size: 11px;
        padding: 6px 12px;
      }
      .emergency-notice {
        bottom: 110px;
        right: 5px;
        font-size: 10px;
        max-width: 150px;
      }
    }
  </style>
</head>
<body>
  <div id="avatar"></div>
  
  <div class="disclaimer">
    ‚ö†Ô∏è This is an AI support companion, NOT a substitute for professional mental health care
  </div>
  
  <div class="status-indicator">
    <span id="status">üîÑ Loading support system...</span>
  </div>
  
  <div class="emergency-notice">
    <strong>Crisis?</strong><br>
    Call 9152987821 (IND)<br>
    or local emergency
  </div>
  
  <div id="bot-response">ü§ó <strong>AI Companion:</strong> Hello, I'm here to listen and support you. This is a safe, non-judgmental space. You can speak or type - take all the time you need. How are you feeling today?</div>
  
  <div class="mic-status" id="micStatus">üé§ I'm listening... Take your time, speak at your own pace</div>

  <div class="voice-controls">
    <h3>üéôÔ∏è Voice</h3>
    <label>Voice: <select id="voiceSelect"><option>Loading...</option></select></label>
    <label>Speed: <input type="range" id="speechRate" min="0.6" max="1.2" value="0.8" step="0.1"></label>
    <label>Tone: <input type="range" id="speechPitch" min="0.8" max="1.4" value="1.0" step="0.1"></label>
    <button onclick="testVoice()">üéµ Test</button>
    <button onclick="toggleSpeech()" id="speechToggle">üîä ON</button>
    <button onclick="requestPermissions()" id="micTest">üé§ Enable</button>
  </div>

  <div id="inputbar">
    <input id="userInput" placeholder="Share your thoughts, or click the microphone to speak freely..." />
    <button id="micBtn" title="Click to speak - no time limits">üé§</button>
    <button id="sendBtn">Send</button>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    // Import Three.js modules
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // Global variables for mental health support
    let scene, camera, renderer, controls, model;
    let voices = [], selectedVoice = null;
    let speechEnabled = true;
    let recognition, isListening = false;
    let conversationHistory = [];

    // DOM elements
    const container = document.getElementById('avatar');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const botResp = document.getElementById('bot-response');
    const voiceSelect = document.getElementById('voiceSelect');
    const speechRate = document.getElementById('speechRate');
    const speechPitch = document.getElementById('speechPitch');
    const status = document.getElementById('status');
    const speechToggle = document.getElementById('speechToggle');
    const micStatus = document.getElementById('micStatus');

    console.log('üåü Starting AI Mental Health Support Companion...');

    // Initialize calming 3D environment
    function initThreeJS() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);

      camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 1.6, 4);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      container.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.03; // Slower, more calming movement

      // Soft, calming lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0x4CAF50, 0.6);
      directionalLight.position.set(5, 10, 7.5);
      scene.add(directionalLight);

      // Gentle, calming geometry
      const geometry = new THREE.SphereGeometry(1.5, 32, 32);
      const material = new THREE.MeshStandardMaterial({ 
        color: 0x4CAF50,
        metalness: 0.1,
        roughness: 0.8,
        transparent: true,
        opacity: 0.7
      });
      const sphere = new THREE.Mesh(geometry, material);
      sphere.position.y = 0;
      scene.add(sphere);

      console.log('‚úÖ Calming 3D environment ready');
      status.innerHTML = '‚úÖ <span class="online">Support System Ready</span>';

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      
      // Gentle floating animation for calming effect
      if (scene.children.length > 2) {
        const sphere = scene.children[2];
        sphere.rotation.y += 0.001;
        sphere.position.y = Math.sin(Date.now() * 0.001) * 0.1;
      }
      
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Unlimited Speech Recognition for Mental Health Support
    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('‚ùå Speech recognition not supported');
        micBtn.style.display = 'none';
        return false;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      // Settings optimized for mental health conversations
      recognition.continuous = true;  // Keep listening
      recognition.interimResults = true;  // Show progress
      recognition.lang = 'en-US';
      recognition.maxAlternatives = 1;
      // NO TIMEOUT - let people speak at their own pace

      recognition.onstart = () => {
        console.log('üé§ Unlimited listening session started');
        isListening = true;
        micBtn.classList.add('listening');
        micBtn.textContent = 'üõë';
        micStatus.style.display = 'block';
        micStatus.textContent = 'üé§ I\'m listening... Take all the time you need. Click microphone to stop.';
        input.placeholder = 'I\'m listening... Speak freely, no rush';
      };

      recognition.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          const transcript = result[0].transcript;
          
          if (result.isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }
        
        // Show interim results with gentle feedback
        if (interimTranscript) {
          input.value = finalTranscript + interimTranscript;
          input.style.background = 'rgba(76, 175, 80, 0.1)'; // Very gentle green
        }
        
        // Process final results but keep listening
        if (finalTranscript) {
          console.log('üéØ Voice input received:', finalTranscript);
          input.value = finalTranscript.trim();
          input.style.background = 'rgba(76, 175, 80, 0.2)'; // Slightly more green
          
          // Don't auto-stop - let them continue if they want
          // User must manually stop by clicking mic again
        }
      };

      recognition.onend = () => {
        console.log('üé§ Voice session ended');
        isListening = false;
        micBtn.classList.remove('listening');
        micBtn.textContent = 'üé§';
        micStatus.style.display = 'none';
        input.placeholder = 'Share your thoughts, or click the microphone to speak freely...';
        
        // Reset background color gently
        setTimeout(() => {
          input.style.background = 'rgba(255, 255, 255, 0.95)';
        }, 3000);
      };

      recognition.onerror = (event) => {
        console.error('‚ùå Speech recognition error:', event.error);
        
        // Handle errors gently for mental health context
        if (event.error === 'not-allowed') {
          micStatus.textContent = 'üîí Microphone access needed. Please allow in browser settings.';
          micStatus.style.background = 'rgba(255, 152, 0, 0.9)';
        } else if (event.error === 'network') {
          micStatus.textContent = 'üì∂ Connection issue. Voice input temporarily unavailable.';
          micStatus.style.background = 'rgba(255, 87, 34, 0.9)';
        } else {
          micStatus.textContent = 'üí¨ Voice unavailable right now. Typing is always available.';
          micStatus.style.background = 'rgba(158, 158, 158, 0.9)';
        }
        
        micStatus.style.display = 'block';
        
        // Reset after showing message
        setTimeout(() => {
          micStatus.style.display = 'none';
          micStatus.style.background = 'linear-gradient(45deg, #4CAF50, #66BB6A)';
        }, 4000);
      };

      return true;
    }

    // Start unlimited voice session
    function startVoiceSession() {
      if (!recognition) {
        input.placeholder = 'Voice not supported. Typing is available anytime.';
        return;
      }

      if (isListening) {
        console.log('üõë Ending voice session');
        recognition.stop();
        return;
      }

      // Request permission and start unlimited session
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(() => {
          try {
            recognition.start();
          } catch (err) {
            input.placeholder = 'Voice temporarily unavailable. Please type your message.';
          }
        })
        .catch(() => {
          input.placeholder = 'Microphone access needed for voice input. Typing is always available.';
        });
    }

    // Request permissions explicitly
    window.requestPermissions = async () => {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        alert('‚úÖ Microphone access granted! You can now use voice input with no time limits.');
      } catch (err) {
        alert('‚ùå Microphone access is needed for voice support. Please allow and try again.');
      }
    };

    // Gentle, supportive TTS
    function initTextToSpeech() {
      function loadVoices() {
        voices = speechSynthesis.getVoices();
        if (voices.length === 0) {
          setTimeout(loadVoices, 200);
          return;
        }

        voiceSelect.innerHTML = '';
        
        // Prioritize calm, gentle voices for mental health
        const supportiveVoices = voices.filter(voice => {
          const name = voice.name.toLowerCase();
          const lang = voice.lang.toLowerCase();
          return lang.includes('en') && (
            name.includes('female') || name.includes('woman') ||
            name.includes('samantha') || name.includes('zira') || 
            name.includes('hazel') || name.includes('karen') || 
            name.includes('susan') || name.includes('serena') ||
            name.includes('alloy') || name.includes('nova') ||
            voice.name.includes('Google UK English Female')
          );
        });

        const allEnglishVoices = voices.filter(v => v.lang.toLowerCase().includes('en'));
        const sortedVoices = [...supportiveVoices, ...allEnglishVoices.filter(v => !supportiveVoices.includes(v))];
        
        sortedVoices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voices.indexOf(voice);
          option.textContent = `${voice.name} ${supportiveVoices.includes(voice) ? 'ü§ó' : ''}`;
          voiceSelect.appendChild(option);
        });

        // Auto-select most supportive voice
        if (supportiveVoices.length > 0) {
          selectedVoice = supportiveVoices[0];
          voiceSelect.value = voices.indexOf(supportiveVoices[0]);
        } else if (allEnglishVoices.length > 0) {
          selectedVoice = allEnglishVoices[0];
          voiceSelect.value = voices.indexOf(allEnglishVoices[0]);
        }
      }

      loadVoices();
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    // Gentle, supportive speech
    function speak(text) {
      if (!speechEnabled || !text?.trim()) return;
      
      try {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text.trim());
        
        if (selectedVoice) utterance.voice = selectedVoice;
        utterance.rate = parseFloat(speechRate.value); // Slower, more calming
        utterance.pitch = parseFloat(speechPitch.value); // Gentle pitch
        utterance.volume = 0.9; // Slightly softer volume
        
        utterance.onstart = () => console.log('ü§ó Speaking supportively');
        utterance.onend = () => console.log('‚úÖ Finished speaking');
        
        speechSynthesis.speak(utterance);
      } catch (err) {
        console.error('‚ùå Speech failed:', err);
      }
    }

    window.testVoice = () => {
      speak("Hello, I'm your AI support companion. I'm here to listen without judgment and provide a safe space for you to share your thoughts and feelings.");
    };

    window.toggleSpeech = () => {
      speechEnabled = !speechEnabled;
      speechToggle.textContent = speechEnabled ? 'üîä ON' : 'üîá OFF';
      speechToggle.style.background = speechEnabled ? 'linear-gradient(45deg, #4CAF50, #66BB6A)' : '#666';
      if (speechEnabled) speak('Voice support is now enabled. I\'m here to listen.');
    };

    // Mental health focused chat with enhanced prompting
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      
      // Store conversation for context
      conversationHistory.push({ role: 'user', content: text });
      
      console.log('üí¨ User sharing:', text);
      botResp.innerHTML = `<strong>You:</strong> ${text}`;
      input.value = '';

      try {
        // Enhanced prompt for mental health support
        const enhancedPrompt = `You are a compassionate AI mental health support companion. Please respond to this person with empathy, active listening, and gentle guidance. Remember:
        - Be non-judgmental and supportive
        - Use person-first language
        - Validate their feelings
        - Offer gentle coping strategies when appropriate
        - Remind them that professional help is available if needed
        - Keep responses conversational but supportive
        
        User's message: "${text}"
        
        Respond as a caring, understanding companion:`;

        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: enhancedPrompt })
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);

        const data = await response.json();
        let reply = data.reply || 'I hear you, and I want you to know that your feelings are valid. Would you like to share more about what\'s on your mind?';
        
        // Store AI response
        conversationHistory.push({ role: 'assistant', content: reply });
        
        console.log('ü§ó AI response:', reply);
        botResp.innerHTML = `<strong>AI Companion:</strong> ${reply}`;
        
        // Speak with gentle, supportive tone
        speak(reply);

      } catch (error) {
        console.error('‚ùå Error:', error);
        const errorMsg = 'I\'m having trouble connecting right now, but I want you to know that I\'m here for you. You can keep sharing, and I\'ll respond as soon as I can. Remember, if you\'re in crisis, please reach out to a mental health professional or call 988.';
        botResp.innerHTML = `<strong>AI Companion:</strong> ${errorMsg}`;
        speak(errorMsg);
      }
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => { 
      if (e.key === 'Enter') sendMessage(); 
    });
    
    micBtn.addEventListener('click', startVoiceSession);
    
    voiceSelect.addEventListener('change', () => {
      selectedVoice = voices[voiceSelect.value];
      speak('Voice updated. I\'m here to support you.');
    });

    // Initialize everything
    initThreeJS();
    const speechRecognitionSupported = initSpeechRecognition();
    initTextToSpeech();
    
    // Supportive welcome message
    setTimeout(() => {
      status.innerHTML = '‚úÖ <span class="online">Support System Active</span>';
      const welcomeMessage = 'Welcome to your safe space. I\'m an AI companion designed to listen and support you. Everything you share here is private. I\'m not a replacement for professional therapy, but I\'m here to provide a non-judgmental space where you can express your thoughts and feelings. How are you doing today?';
      botResp.innerHTML = `<strong>AI Companion:</strong> ${welcomeMessage}`;
      speak(welcomeMessage);
    }, 2000);

    console.log('üåü AI Mental Health Support Companion is ready to help');
  </script>
</body>
</html>
